@if (dialogService.isOpen()) {
<div class="dialog-backdrop" (click)="onBackdropClick($event)">
    <div class="dialog-panel" role="dialog" aria-modal="true" aria-labelledby="dialog-title">

        <!-- Header -->
        <div class="dialog-header">
            <h2 id="dialog-title">{{ 'DIALOG.TITLE' | translate }}</h2>
            <button class="close-btn" (click)="close()" aria-label="Close">‚úï</button>
        </div>

        <!-- Form -->
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="dialog-body">

            <!-- Size -->
            <div class="field">
                <label for="size">{{ 'DIALOG.SIZE' | translate }} <span class="req">*</span></label>
                <div class="select-wrap">
                    <select id="size" formControlName="size">
                        @for (s of sizes; track s) {
                        <option [value]="s">{{ s }}</option>
                        }
                    </select>
                    <span class="select-arrow">‚åÉ</span>
                </div>
            </div>


            <!-- Category -->
            <div class="field">
                <label for="category">{{ 'DIALOG.CATEGORY' | translate }} <span class="req">*</span></label>
                <div class="select-wrap">
                    <select id="category" formControlName="category">
                        @for (cat of categories; track cat[0]) {
                        <option [value]="cat[1]">{{ 'CATEGORIES.' + cat[0] | translate }}</option>
                        }
                    </select>
                    <span class="select-arrow">‚åÉ</span>
                </div>
            </div>

            <!-- Description -->
            <div class="field">
                <label for="description">{{ 'DIALOG.DESCRIPTION' | translate }}</label>
                <textarea id="description" formControlName="description" rows="4"
                    [placeholder]="'DIALOG.DESC_PLACEHOLDER' | translate"></textarea>
            </div>

            <!-- Date & Time -->
            <div class="field-row">
                <div class="field" [class.error]="isInvalid('date') || form.hasError('pastDateTime')">
                    <label for="date">{{ 'DIALOG.DATE' | translate }} <span class="req">*</span></label>
                    <input id="date" type="date" formControlName="date" [min]="minDate()">
                    @if (isInvalid('date')) { <p class="error-msg">{{ 'DIALOG.ERR_REQUIRED' | translate }}</p> }
                </div>
                <div class="field" [class.error]="isInvalid('time') || form.hasError('pastDateTime')">
                    <label for="time">{{ 'DIALOG.TIME' | translate }} <span class="req">*</span></label>
                    <input id="time" type="time" formControlName="time" [min]="minTime()">
                    @if (isInvalid('time')) { <p class="error-msg">{{ 'DIALOG.ERR_REQUIRED' | translate }}</p> }
                </div>
            </div>
            @if (form.hasError('pastDateTime') && (form.get('date')?.touched || form.get('time')?.touched)) {
            <p class="error-msg global-error">{{ 'DIALOG.ERR_PAST' | translate }}</p>
            }

            <!-- Location with autocomplete -->
            <div class="field location-field" [class.error]="isInvalid('locationText')">
                <label for="location">{{ 'DIALOG.LOCATION' | translate }} <span class="req">*</span></label>
                <div class="input-icon-wrap">
                    <span class="input-icon">üìç</span>
                    <input id="location" type="text" autocomplete="off" formControlName="locationText"
                        (focus)="showNearby()" (blur)="hideDropdown()"
                        [placeholder]="'DIALOG.LOC_PLACEHOLDER' | translate">
                    @if (locationLoading()) {
                    <span class="loc-spinner">‚ü≥</span>
                    }
                </div>

                <!-- Geolocation status bar -->
                @if (geo.loading()) {
                <p class="loc-status">{{ 'DIALOG.LOC_DETECTING' | translate }}</p>
                } @else if (locationError()) {
                <p class="loc-status error">{{ 'DIALOG.ERR_GEO_FAILED' | translate }}</p>
                }

                <!-- Autocomplete dropdown -->
                @if (showDropdown() && locationResults().length > 0) {
                <div class="location-dropdown">
                    @for (loc of locationResults(); track loc.lat) {
                    <button type="button" class="loc-option" (mousedown)="selectLocation(loc)">
                        <span class="loc-pin">üìç</span>
                        <span class="loc-name">{{ loc.shortName }}</span>
                        <span class="loc-meta">{{ loc.displayName.split(',').slice(1, 3).join(',') }}</span>
                    </button>
                    }
                </div>
                }

                <p class="hint">{{ 'DIALOG.LOC_HINT' | translate }}</p>
                @if (isInvalid('locationText')) {
                <p class="error-msg">{{ 'DIALOG.ERR_LOC' | translate }}</p>
                }
            </div>

            <!-- Toggles -->
            <div class="toggle-card">
                <div class="toggle-info">
                    <h4>{{ 'DIALOG.INVITE_ONLY' | translate }}</h4>
                    <p>{{ 'DIALOG.INVITE_DESC' | translate }}</p>
                </div>
                <label class="switch">
                    <input type="checkbox" formControlName="isInviteOnly">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="toggle-card">
                <div class="toggle-info">
                    <h4>{{ 'DIALOG.MEN_ONLY' | translate }}</h4>
                </div>
                <label class="switch">
                    <input type="checkbox" formControlName="isMenOnly">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="toggle-card">
                <div class="toggle-info">
                    <h4>{{ 'DIALOG.AGE_RANGE' | translate }}</h4>
                    <p>{{ 'DIALOG.AGE_DESC' | translate }}</p>
                </div>
                <label class="switch">
                    <input type="checkbox" formControlName="hasAgeRange">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Footer -->
            <div class="dialog-footer">
                <button type="button" class="btn-cancel" (click)="close()">{{ 'DIALOG.CANCEL' | translate }}</button>
                <button type="submit" class="btn-submit" [disabled]="form.invalid">{{ 'DIALOG.SUBMIT' | translate
                    }}</button>
            </div>
        </form>
    </div>
</div>
}